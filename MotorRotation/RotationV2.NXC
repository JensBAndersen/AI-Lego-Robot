const byte bSensor = IN_4;
const byte lSensor = IN_1;
const byte rSensor = IN_2;

const byte rMotor  = OUT_A;
const byte lMotor  = OUT_B;

const long sqUnit    = 630;
const long lTurn    = 266.25; // 0.425 * 630 - 90 degree turn
const long revTurn  = 535.5 ; // 0.85  * 630 - 180 degree turn
  
const int lMotorBias = 3;
const int rMotorBias = 0;
int state = -100;
long lRot, rRot = 0;

bool SensorLeft = false;
bool SensorRight = false;
bool SensorBack = false;

void setupNXT(){
     SetSensorLight(bSensor);
	 SetSensorLight(lSensor);
	 SetSensorLight(rSensor);
	 ResetTachoCount(OUT_AB);
}

int powerMotors(int dir, char pwr){
	if (state != dir){
	Off(OUT_AB);
	ResetRotationCount(OUT_AB);
	state = dir;
  lRot = 0;
  rRot = 0;
	}
	switch (dir){
		case -1: //backwards
			OnFwd(rMotor, pwr-rMotorBias);
			OnFwd(lMotor, pwr-lMotorBias);
			break;
		case 0:	//forwards
			OnRev(rMotor, pwr-rMotorBias);
			OnRev(lMotor, pwr-lMotorBias);
			break;
	
		case 1:	//left
			OnFwd(rMotor, pwr-rMotorBias);
			OnRev(lMotor, pwr-lMotorBias);
			break;
		
		case 2: //right
			OnRev(rMotor, pwr-rMotorBias);
			OnFwd(lMotor, pwr-lMotorBias);
			break;
		default:
			Off(OUT_AB);
			break;
	}
}

/*void checkSensor(){
  if(Sensor(IN_1) < Black1){SensorLeft = true;} //A
  if(Sensor(IN_2) < Black2){SensorRight = true;} //B
  if(Sensor(IN_4) < Black4){SensorBack = true;} //C
} */
void followLine(long pwr = 40){
  int bufferRight = 65 - Sensor(IN_1);
  int buffeLeft = 73 - Sensor(IN_2);

  OnRev(OUT_A, pwr + bufferRight);
  OnRev(OUT_B, pwr-3 + buffeLeft);

}


bool readTacho(long thresh){
	lRot = labs(MotorRotationCount(OUT_A));
	rRot = labs(MotorRotationCount(OUT_B));
	
	if ((lRot > thresh) && (rRot > thresh)){
    return true;
    }
  else return false;
}

void oneSquare(){
powerMotors(0, 50);
bool running = true;
 while (running){
       followLine();
       if ( (Sensor(lSensor) < 55)  && (Sensor(rSensor) < 55) ){running = false;}

 }
 powerMotors(10,0);
 while(!readTacho(200)){
 powerMotors(0,35);
 }
}

task main(){
	setupNXT();
  oneSquare();

 Off(OUT_AB);
}
